// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// for admin
enum AdminRole {
  admin
  superAdmin
}

// for teacher
enum TeacherSpecialty {
  english
  french
  spanish
  italian
  german
}

// for lesson
enum LessonStatus {
  available
  booked
  completed
  cancelled
}

// for transaction
enum TransactionStatus {
  pending
  paid
  cancelled
}

model Admin {
  id          String    @id @default(uuid())
  username    String    @unique
  password    String
  role        AdminRole
  phoneNumber String?

  @@map("admin")
}

model Teacher {
  id                    String            @id @default(uuid())
  email                 String            @unique
  phoneNumber           String?
  fullName              String
  password              String
  cardNumber            String?
  isActive              Boolean           @default(true)
  isDelete              Boolean           @default(false)
  role                  String            @default("teacher")
  specification         TeacherSpecialty?
  level                 String?
  description           String?
  hourPrice             Int?
  portfolioLink         String?
  imageUrl              String?
  googleId              String?
  googleRefreshToken    String?
  googleAccessToken     String?
  rating                Int?
  experience            String?
  lessons               Lesson[]
  deletedTeacher        DeletedTeacher[]
  lessonTemplates       LessonTemplate[]
  teacherPayments       TeacherPayment[]
  lessonHistories       LessonHistory[]

  @@map("teacher")
}

model DeletedTeacher {
  id         String    @id @default(uuid())
  teacher    Teacher   @relation(fields: [teacherId], references: [id])
  teacherId  String
  deletedBy  String
  reason     String?
  deletedAt  DateTime  @default(now())
  restoreAt  DateTime?

  @@map("deletedTeacher")
}

model Student {
  id               String            @id @default(uuid())
  lastName         String
  firstName        String
  phoneNumber      String?
  role             String            @default("student")
  tgId             String?
  tgUsername       String?
  isBlocked        Boolean           @default(false)
  blockedAt        DateTime?
  blockedReason    String?
  lessons          Lesson[]
  lessonHistories  LessonHistory[]
  notifications    Notification[]
  transactions     Transaction[]

  @@map("student")
}

model LessonTemplate {
  id          String   @id @default(uuid())
  teacher     Teacher  @relation(fields: [teacherId], references: [id])
  teacherId   String
  name        String
  timeSlot    String

  @@map("lessonTemplate")
}

model Lesson {
  id                  String            @id @default(uuid())
  name                String
  startTime           DateTime
  endTime             DateTime
  teacher             Teacher           @relation(fields: [teacherId], references: [id])
  teacherId           String
  student             Student           @relation(fields: [studentId], references: [id])
  studentId           String
  googleMeetsUrl      String?
  status              LessonStatus
  googleEventId       String?
  price               Decimal
  isPaid              Boolean           @default(false)
  teacherPayment      TeacherPayment?
  bookedAt            DateTime          @default(now())
  remainedLessonId    String?
  completedAt         DateTime?
  notification        Notification?
  transactions        Transaction[]
  lessonHistories     LessonHistory[]

  @@map("lesson")
}

model TeacherPayment {
  id                  String    @id @default(uuid())
  teacher             Teacher   @relation(fields: [teacherId], references: [id])
  teacherId           String
  lesson              Lesson    @relation(fields: [lessonId], references: [id])
  lessonId            String    @unique
  totalLessonAmount   Int
  platformComission   Int
  platformAmount      Int
  teacherAmount       Int
  paidBy              String
  paidAt              DateTime
  isCanceled          Boolean   @default(false)
  canceledAt          DateTime?
  canceledBy          String?
  canceledReason      String?
  notes               String?

  @@map("teacherPayment")
}

model Transaction {
  id              String            @id @default(uuid())
  lesson          Lesson            @relation(fields: [lessonId], references: [id])
  lessonId        String
  student         Student           @relation(fields: [studentId], references: [id])
  studentId       String
  price           Decimal
  status          TransactionStatus
  canceledTime    DateTime?
  performedTime   DateTime?
  reason          String?

  @@map("transaction")
}

model Notification {
  id         String    @id @default(uuid())
  student    Student   @relation(fields: [studentId], references: [id])
  studentId  String
  lesson     Lesson    @relation(fields: [lessonId], references: [id])
  lessonId   String    @unique
  message    String
  sendAt     DateTime
  isSend     Boolean   @default(false)

  @@map("notification")
}

model LessonHistory {
  id         String   @id @default(uuid())
  lesson     Lesson   @relation(fields: [lessonId], references: [id])
  lessonId   String
  star       Int?
  feedback   String?
  teacher    Teacher  @relation(fields: [teacherId], references: [id])
  teacherId  String
  student    Student  @relation(fields: [studentId], references: [id])
  studentId  String

  @@map("lessonHistory")
}